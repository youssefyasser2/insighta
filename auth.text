// import 'dart:math';

// import 'package:dio/dio.dart';
// import 'package:flutter_bloc/flutter_bloc.dart';
// import 'package:test_app/core/utils/auth_storage.dart';
// import 'package:test_app/features/auth/data/models/user_model.dart';
// import 'package:test_app/features/auth/logic/auth_state.dart';
// import 'package:test_app/core/utils/validators.dart';

// class AuthCubit extends Cubit<AuthState> {
//   AuthCubit() : super(AuthInitial());

//   final Dio _dio = Dio(
//     BaseOptions(
//       baseUrl: "https://67b8b14a699a8a7baef4f48b.mockapi.io/api",
//       contentType: Headers.jsonContentType,
//     ),
//   );

//   bool stayConnected = false;

//   /// âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
//   Future<void> login(String email, String password) async {
//     if (email.isEmpty || password.isEmpty) {
//       emit(AuthFailure("Email and password cannot be empty"));
//       return;
//     }

//     emit(AuthLoading());

//     try {
//       final response = await _dio.get(
//         'login',
//       ); // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù€ endpoint Ø§Ù„ØµØ­ÙŠØ­

//       print("ğŸ”¹ Server Response: ${response.data}");

//       if (response.statusCode == 200) {
//         final List<dynamic> data = response.data;

//         final user = data.cast<Map<String, dynamic>>().firstWhere(
//           (user) =>
//               user['email']?.toString().trim() == email.trim() &&
//               user['password']?.toString().trim() == password.trim(),
//           orElse: () => <String, dynamic>{}, // âœ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† `null`
//         );

//         if (user.isEmpty) {
//           // âœ… Ø§Ù„Ø¢Ù† ÙŠØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
//           emit(AuthFailure("Invalid email or password"));
//           return;
//         }

//         final userModel = UserModel.fromJson({
//           ...user,
//           'accessToken': user['accessToken'] ?? _generateToken(),
//           'refreshToken': user['refreshToken'] ?? _generateToken(),
//           'expiresIn':
//               user['expiresIn'] ??
//               DateTime.now().add(Duration(hours: 1)).toIso8601String(),
//         });

//         await AuthStorage.saveTokens(
//           accessToken: userModel.accessToken,
//           refreshToken: userModel.refreshToken,
//           expiresIn: userModel.expiresIn.toIso8601String(),
//         );

//         print("âœ… Login Successful! User ID: ${userModel.id}");

//         emit(AuthSuccess(userId: userModel.id, user: userModel));
//       } else {
//         emit(
//           AuthFailure(
//             "Failed to load data. Status code: ${response.statusCode}",
//           ),
//         );
//       }
//     } on DioException catch (e) {
//       print("âŒ DioException: ${e.message}");
//       print("ğŸ”¹ Dio Response: ${e.response?.data}");

//       emit(
//         AuthFailure(
//           e.response?.data?['error'] ?? "An unexpected error occurred",
//         ),
//       );
//     } catch (e) {
//       emit(AuthFailure("An error occurred: $e"));
//     }
//   }

//   /// âœ… Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙˆÙƒÙ† Ø¹Ø´ÙˆØ§Ø¦ÙŠ

//   /// âœ… ØªÙˆÙ„ÙŠØ¯ ØªÙˆÙƒÙ† ÙØ±ÙŠØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Random Ùˆ DateTime
//   String _generateToken() {
//     final random = Random();
//     final timestamp = DateTime.now().millisecondsSinceEpoch;
//     final randomPart = random.nextInt(1000000); // Ø¬Ø²Ø¡ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø®ØªÙ„Ø§Ù
//     return '$timestamp$randomPart';
//   }

//   /// âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
//   Future<void> checkAuthStatus() async {
//     emit(AuthLoading());

//     final accessToken = await AuthStorage.getValidAccessToken();
//     if (accessToken != null) {
//       emit(AuthSuccess(userId: "stored_user_id"));
//     } else {
//       emit(AuthInitial());
//     }
//   }

//   /// âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆÙƒÙ†
//   Future<void> refreshToken() async {
//     final refreshToken = await AuthStorage.getRefreshToken();
//     if (refreshToken == null) {
//       logout();
//       return;
//     }

//     emit(AuthLoading());
//     try {
//       final response = await _dio.post(
//         '/refresh',
//         data: {'refresh_token': refreshToken},
//       );

//       if (response.statusCode == 200) {
//         final data = response.data;

//         if (data['access_token'] != null && data['refresh_token'] != null) {
//           await AuthStorage.saveTokens(
//             accessToken: data['access_token'],
//             refreshToken: data['refresh_token'],
//             expiresIn: data['expiresIn'],
//           );
//         }

//         emit(AuthSuccess(userId: "stored_user_id"));
//       } else {
//         logout();
//       }
//     } on DioException catch (e) {
//       print("Error while refreshing token: ${e.message}");
//       logout();
//     }
//   }

//   /// âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
//   Future<void> logout() async {
//     await AuthStorage.clearTokens();
//     stayConnected = false;
//     emit(AuthInitial());
//   }

//   /// âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆØ¯ OTP
//   Future<void> verifyCode(String email, String code) async {
//     emit(AuthLoading());
//     try {
//       final response = await _dio.post(
//         '/verify-code',
//         data: {'email': email, 'code': code},
//       );

//       if (response.statusCode == 200) {
//         emit(VerifyCodeSuccess());
//       } else {
//         emit(AuthFailure("Invalid verification code"));
//       }
//     } on DioException {
//       emit(AuthFailure("Network error, please check your connection"));
//     }
//   }

//   /// âœ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
//   Future<void> register(
//     String username,
//     String email,
//     String password,
//     String confirmPassword,
//   ) async {
//     if (!_validateRegistrationFields(
//       username,
//       email,
//       password,
//       confirmPassword,
//     )) {
//       return;
//     }

//     emit(AuthLoading());

//     try {
//       final requestData = _buildRegisterRequest(username, email, password);
//       final response = await _dio.post('/login', data: requestData);

//       _handleRegisterResponse(response);
//     } on DioException catch (e) {
//       _handleDioError(e);
//     } catch (e) {
//       print("âŒ Unknown Error: $e");
//       emit(AuthFailure("An unexpected error occurred"));
//     }
//   }

//   /// ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø¸Ù…
//   Map<String, dynamic> _buildRegisterRequest(
//     String username,
//     String email,
//     String password,
//   ) {
//     return {
//       'username': username,
//       'email': email,
//       'password': password,
//       'accessToken': _generateToken(),
//       'refreshToken': _generateToken(),
//       'expiresIn': DateTime.now().add(Duration(hours: 1)).toIso8601String(),
//     };
//   }

//   /// ğŸ”¹ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
//   void _handleRegisterResponse(Response response) async {
//     print("ğŸ”¹ Register Response Status: ${response.statusCode}");
//     print("ğŸ”¹ Register Response Data: ${response.data}");

//     if (response.statusCode == 201) {
//       final data = response.data;

//       if (data != null && data.containsKey('id')) {
//         final user = UserModel.fromJson(data);
//         await _saveUserTokens(user);
//         emit(
//           AuthSuccess(
//             userId: user.id,
//             user: user,
//             message: "Registration successful",
//           ),
//         );
//       } else {
//         print("âŒ Missing 'id' field in response!");
//         emit(AuthFailure("Registration failed: Missing user ID"));
//       }
//     } else {
//       print("âŒ Unexpected status code: ${response.statusCode}");
//       emit(AuthFailure("Registration failed: ${response.statusCode}"));
//     }
//   }

//   /// ğŸ”¹ Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†
//   Future<void> _saveUserTokens(UserModel user) async {
//     await AuthStorage.saveTokens(
//       accessToken: user.accessToken,
//       refreshToken: user.refreshToken,
//       expiresIn: user.expiresIn.toIso8601String(),
//     );
//   }

//   /// ğŸ”¹ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ Dio
//   void _handleDioError(DioException e) {
//     print("âŒ DioException: ${e.message}");
//     print("ğŸ”¹ Dio Response: ${e.response?.data}");

//     emit(
//       AuthFailure(e.response?.data?['error'] ?? "An unexpected error occurred"),
//     );
//   }

//   /// âœ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
//   Future<void> changePassword(String userId, String newPassword) async {
//     if (!_validatePassword(newPassword)) return;

//     emit(AuthLoading());
//     try {
//       final response = await _dio.put(
//         '/users/$userId',
//         data: {'password': newPassword},
//       );

//       if (response.statusCode == 200) {
//         emit(
//           AuthSuccess(userId: userId, message: "Password changed successfully"),
//         );
//       } else {
//         emit(AuthFailure("Failed to change password"));
//       }
//     } on DioException catch (e) {
//       emit(AuthFailure(e.response?.data['error'] ?? "An error occurred"));
//     }
//   }

//   /// âœ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
//   Future<void> forgotPassword(String email) async {
//     if (!Validators.isValidEmail(email)) {
//       emit(AuthFailure("Please enter a valid email address"));
//       return;
//     }

//     emit(AuthLoading());
//     try {
//       await Future.delayed(const Duration(seconds: 2)); // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø·Ù„Ø¨
//       emit(ForgotPasswordSuccess());
//     } catch (e) {
//       emit(AuthFailure("An error occurred"));
//     }
//   }

//   /// âœ… ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± "Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ù…ØªØµÙ„Ø§Ù‹"
//   void toggleStayConnected(bool value) {
//     stayConnected = value;
//     emit(AuthStayConnectedChanged(stayConnected));
//   }

//   /// âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ
//   void socialLogin(String platform) {
//     emit(AuthSocialLogin(platform));
//   }

//   // ğŸ”¹ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø®Ø§ØµØ©

//   bool _validateRegistrationFields(
//     String username,
//     String email,
//     String password,
//     String confirmPassword,
//   ) {
//     if ([username, email, password, confirmPassword].any((e) => e.isEmpty)) {
//       emit(AuthFailure("All fields are required"));
//       return false;
//     }

//     if (!Validators.passwordsMatch(password, confirmPassword)) {
//       emit(AuthFailure("Passwords do not match"));
//       return false;
//     }

//     if (!Validators.isValidEmail(email)) {
//       emit(AuthFailure("Invalid email address"));
//       return false;
//     }
//     return true;
//   }

//   bool _validatePassword(String password) {
//     if (!Validators.isValidPassword(password)) {
//       emit(
//         AuthFailure(
//           "Password must be at least 8 characters long, contain a letter, a number, and a special character.",
//         ),
//       );
//       return false;
//     }
//     return true;
//   }
// }
